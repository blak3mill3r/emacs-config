#!/bin/bash

ZENAME=$1

SOCKET_PATH=/run/user/1000/emacs
SOCKET_NAME=$SOCKET_PATH/server

tmux new-session -d -s gargar "emacsclient -s $SOCKET_NAME -e \"(rename-server \\\"$ZENAME\\\")\" -nw" >> /tmp/wtf.log 2>&1 

#echo "the tmux exits $?" >> /tmp/wtf.log

while [ ! -e $SOCKET_PATH/$ZENAME ]
do
  #echo "awaiting socket $SOCKET_PATH/$ZENAME" >> /tmp/wtf.log 
  sleep 0.125
done
emacsclient -s $SOCKET_PATH/$ZENAME -c -n "${@:2}" -e "(prepare-to-die)" >> /tmp/wtf.log 2>&1

#echo "the emacsclient exits $?" >> /tmp/wtf.log

# now what would be slick is
# md5sum -z ~/.emacs.d/cfg/*.el|md5sum -
# keep that hash, and somehow automatically make a new CRIU image in the background if it has changed
